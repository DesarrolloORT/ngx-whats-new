name: Publish package and attach to release

on:
  release:
    types: [published]

jobs:
  release:
    name: Publish package and attach to release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'

      - name: Authenticate to GitHub Packages
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" > ~/.npmrc
          echo "@desarrolloort:registry=https://npm.pkg.github.com" >> ~/.npmrc

      - name: Install dependencies
        run: npm install

      - name: Publish package
        run: npm run release

      - name: Generate tarball
        run: npm pack

      - name: Upload tarball to release
        uses: AButler/upload-release-assets@v3.0
        with:
          files: 'dist/ngx-whats-new/*.tgz'
          release-tag: ${{ github.event.release.tag_name }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify release via email and MS Teams
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Fetch release notes
        id: release_info
        run: |
          release_info=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                      "https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }}")
          release_notes=$(echo "$release_info" | jq -r '.body')
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$release_notes" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send email
        uses: cinotify/github-action@main
        with:
          to: ${{ secrets.NOTIFY_EMAIL }}
          subject: ${{ github.event.release.name }}
          body: ${{env.RELEASE_NOTES}}
          type: 'text/html'

      - name: Microsoft Teams Notification
        if: always()
        uses: jdcargile/ms-teams-notification@v1.4
        with:
          github-token: ${{ github.token }}
          ms-teams-webhook-uri: ${{ secrets.MS_TEAMS_RELEASE_CHANNEL_WEBHOOK_URI }}
          notification-summary: 'ngx-whats-new release: ${{ github.event.release.name }}'
          notification-color: #4cb765
          timezone: America/Montevideo
